<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bank Letter - Transfer of Fund through RTGS - UPPCL</title>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Vue.js 2 CDN -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>

    <!-- docx library for generating DOCX files -->
    <script type="module">
      import * as docx from "https://cdn.skypack.dev/docx@8.2.2";
      window.docx = docx;
      console.log("DOCX library loaded via ESM:", Object.keys(docx));
    </script>

    <!-- FileSaver.js for downloading files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  </head>
  <body class="bg-gray-50 min-h-screen">
    <div id="app" class="container mx-auto p-6 max-w-6xl">
      <!-- Header -->
      <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <div class="text-center border-b pb-4">
          <h1 class="text-2xl font-bold text-gray-800">Bank Letter Generator</h1>
          <p class="text-lg text-gray-600 mt-1">Transfer of Fund through RTGS</p>
        </div>
      </div>

      <!-- Main Form -->
      <div class="bg-white rounded-lg shadow-md p-6">
        <!-- Letter Details -->
        <div class="mb-6">
          <h3 class="text-lg font-semibold text-gray-700 mb-3">Letter Details</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Letter No.</label>
              <input v-model="formData.letterNo" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., Sec/UNL/CPF Trust/" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Date</label>
              <input v-model="formData.date" type="date" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" />
            </div>
          </div>
        </div>

        <!-- Recipient Details -->
        <div class="mb-6">
          <h3 class="text-lg font-semibold text-gray-700 mb-3">Recipient Details</h3>
          <div class="space-y-3">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">To (Designation)</label>
              <input v-model="formData.recipientDesignation" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., The Branch Manager" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Bank Name</label>
              <input v-model="formData.bankName" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., Central Bank of India" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Branch Address</label>
              <input v-model="formData.branchAddress" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., Joppling Road Br, Lucknow" />
            </div>
          </div>
        </div>

        <!-- Letter Body -->
        <div class="mb-6">
          <h3 class="text-lg font-semibold text-gray-700 mb-3">Letter Body</h3>
          <div class="space-y-3">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">CBI Account Number</label>
              <input v-model="formData.cbiAccountNo" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., 1233789900" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">PAN Number</label>
              <input v-model="formData.panNo" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., AAATU2424L" />
            </div>
          </div>
        </div>

        <!-- Bank Account Details Table -->
        <div class="mb-6">
          <div class="flex justify-between items-center mb-3">
            <h3 class="text-lg font-semibold text-gray-700">Bank Account Details</h3>
            <button @click="addAccount" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">+ Add Account</button>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full border-collapse border border-gray-300 text-sm">
              <thead>
                <tr class="bg-gray-100">
                  <th class="border border-gray-300 px-2 py-2 text-left w-12">Sl. No.</th>
                  <th class="border border-gray-300 px-2 py-2 text-left">Name of Account</th>
                  <th class="border border-gray-300 px-2 py-2 text-left">Bank/Branch</th>
                  <th class="border border-gray-300 px-2 py-2 text-left">Account No.</th>
                  <th class="border border-gray-300 px-2 py-2 text-left w-24">Type of A/c</th>
                  <th class="border border-gray-300 px-2 py-2 text-left">IFSC Code</th>
                  <th class="border border-gray-300 px-2 py-2 text-left w-32">Amount</th>
                  <th class="border border-gray-300 px-2 py-2 text-center w-16">Action</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="(account, index) in formData.accounts" :key="index" class="hover:bg-gray-50">
                  <td class="border border-gray-300 px-2 py-2 text-center">{{ index + 1 }}</td>
                  <td class="border border-gray-300 px-2 py-2 text-sm">
                    <span v-if="account.isPrePopulated">{{ account.name }}</span>
                    <input v-else v-model="account.name" type="text" class="w-full px-2 py-1 border-0 bg-transparent focus:outline-none focus:bg-white focus:border focus:border-blue-500 rounded text-sm" placeholder="Account name" />
                  </td>
                  <td class="border border-gray-300 px-2 py-2 text-sm">
                    <span v-if="account.isPrePopulated">{{ account.bank }}</span>
                    <input v-else v-model="account.bank" type="text" class="w-full px-2 py-1 border-0 bg-transparent focus:outline-none focus:bg-white focus:border focus:border-blue-500 rounded text-sm" placeholder="Bank name" />
                  </td>
                  <td class="border border-gray-300 px-2 py-2 text-sm">
                    <span v-if="account.isPrePopulated">{{ account.accountNo }}</span>
                    <input v-else v-model="account.accountNo" type="text" class="w-full px-2 py-1 border-0 bg-transparent focus:outline-none focus:bg-white focus:border focus:border-blue-500 rounded text-sm" placeholder="Account no" />
                  </td>
                  <td class="border border-gray-300 px-2 py-2 text-sm">
                    <span v-if="account.isPrePopulated">{{ account.accountType }}</span>
                    <input v-else v-model="account.accountType" type="text" class="w-full px-2 py-1 border-0 bg-transparent focus:outline-none focus:bg-white focus:border focus:border-blue-500 rounded text-sm" placeholder="C/A/c" />
                  </td>
                  <td class="border border-gray-300 px-2 py-2 text-sm">
                    <span v-if="account.isPrePopulated">{{ account.ifsc }}</span>
                    <input v-else v-model="account.ifsc" type="text" class="w-full px-2 py-1 border-0 bg-transparent focus:outline-none focus:bg-white focus:border focus:border-blue-500 rounded text-sm" placeholder="IFSC code" />
                  </td>
                  <td class="border border-gray-300 px-2 py-2">
                    <input v-model.number="account.amount" type="number" step="0.01" class="w-full px-2 py-1 border-0 bg-transparent focus:outline-none focus:bg-white focus:border focus:border-blue-500 rounded text-sm" placeholder="0.00" />
                  </td>
                  <td class="border border-gray-300 px-2 py-2 text-center">
                    <button v-if="!account.isPrePopulated" @click="removeAccount(index)" class="text-red-600 hover:text-red-800 text-sm px-2 py-1" title="Remove">✕</button>
                    <span v-else class="text-gray-400 text-xs">-</span>
                  </td>
                </tr>
              </tbody>
              <tfoot>
                <tr class="bg-gray-100 font-semibold">
                  <td class="border border-gray-300 px-2 py-2 text-right" colspan="6">Total</td>
                  <td class="border border-gray-300 px-2 py-2">{{ accountsTotal | currency }}</td>
                  <td class="border border-gray-300 px-2 py-2"></td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>

        <!-- Cheque Details -->
        <div class="mb-6">
          <h3 class="text-lg font-semibold text-gray-700 mb-3">Cheque Details</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Cheque Number</label>
              <input v-model="formData.chequeNo" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., 207798" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Cheque Date</label>
              <input v-model="formData.chequeDate" type="date" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" />
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex flex-col sm:flex-row gap-4 justify-center">
          <button @click="generatePreview" class="px-6 py-3 bg-green-600 text-white rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500">Preview Document</button>
          <button @click="generateDocx" class="px-6 py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">Generate DOCX</button>
          <button @click="clearForm" class="px-6 py-3 bg-gray-600 text-white rounded-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500">Clear & Reset</button>
        </div>
      </div>

      <!-- Preview Modal -->
      <div v-if="showPreview" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg max-w-6xl w-full max-h-screen overflow-y-auto">
          <div class="p-6">
            <div class="flex justify-between items-center mb-4">
              <h2 class="text-xl font-bold">Document Preview</h2>
              <button @click="showPreview = false" class="text-gray-500 hover:text-gray-700">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>
            <div v-html="previewContent" class="border p-4 bg-white text-sm"></div>
            <div class="mt-4 flex justify-end">
              <button @click="generateDocx" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 mr-2">Download DOCX</button>
              <button @click="showPreview = false" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700">Close</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      new Vue({
        el: "#app",
        data: {
          showPreview: false,
          previewContent: "",
          isAutoSyncingChequeDate: false,
          logoUrl: "./logo.png",
          formData: {
            letterNo: "Sec/UNL/CPF Trust/",
            date: new Date().toISOString().split("T")[0],
            recipientDesignation: "The Branch Manager",
            bankName: "Central Bank of India",
            branchAddress: "Joppling Road Br, Lucknow",
            cbiAccountNo: "1233789900",
            panNo: "AAATU2424L",
            chequeNo: "207798",
            chequeDate: new Date().toISOString().split("T")[0],
            accounts: [
              {
                name: "UP Rajya Vidyut Utpadan Nigam Ltd",
                bank: "State Bank Of India",
                accountNo: "10101987768",
                accountType: "C/A/c",
                ifsc: "SBIN0003347",
                amount: 0,
                isPrePopulated: true,
              },
              {
                name: "Dy CAO, CFA&BO PTPS, Panki, Kanpur",
                bank: "State Bank of India, Panki",
                accountNo: "42133266785",
                accountType: "C/A/c",
                ifsc: "SBIN0011607",
                amount: 0,
                isPrePopulated: true,
              },
              {
                name: "Dy CAO, P&AD, OTPS, Obra",
                bank: "Indian Bank Obra",
                accountNo: "20489383973",
                accountType: "C/A/c",
                ifsc: "IDIB000O501",
                amount: 0,
                isPrePopulated: true,
              },
              {
                name: "CFA&BO, CTPS, Obra",
                bank: "HDFC Bank",
                accountNo: "50200025132408",
                accountType: "C/A/c",
                ifsc: "HDFC0002358",
                amount: 0,
                isPrePopulated: true,
              },
              {
                name: 'Dy CAO, CFA&BO, Anpara "A"TPS',
                bank: "State Bank of India",
                accountNo: "10722279089",
                accountType: "C/A/c",
                ifsc: "SBIN0006339",
                amount: 0,
                isPrePopulated: true,
              },
              {
                name: 'Dy CAO, CFA&BO, Anpara "B"TPS',
                bank: "State Bank of India, Anpara",
                accountNo: "10722279192",
                accountType: "C/A/c",
                ifsc: "SBIN0006339",
                amount: 0,
                isPrePopulated: true,
              },
              {
                name: 'DGM(F), Constn. Unit CFA&BO, Anpara "D"TPP',
                bank: "State Bank of India, Anpara",
                accountNo: "30299251267",
                accountType: "C/A/c",
                ifsc: "SBIN0006339",
                amount: 0,
                isPrePopulated: true,
              },
              {
                name: "SAO, EPAD, UPRVUNL, Harduaganj O&M Kasimpur",
                bank: "State Bank Of India",
                accountNo: "11264105070",
                accountType: "C/A/c",
                ifsc: "SBIN0001364",
                amount: 0,
                isPrePopulated: true,
              },
              {
                name: "SAO, EPAD, UPRVUNL, Harduaganj Extn Kasimpur",
                bank: "State Bank Of India",
                accountNo: "11264105149",
                accountType: "C/A/c",
                ifsc: "SBIN0001364",
                amount: 0,
                isPrePopulated: true,
              },
              {
                name: "CFA & BO, 1x660, Harduaganj, Kasimpur",
                bank: "State Bank Of India",
                accountNo: "33978063601",
                accountType: "C/A/c",
                ifsc: "SBIN0001364",
                amount: 0,
                isPrePopulated: true,
              },
              {
                name: "CFA & BO, 2x210, Parichha Jhansi",
                bank: "State Bank of India, Parichha",
                accountNo: "10653208048",
                accountType: "C/A/c",
                ifsc: "SBIN0006149",
                amount: 0,
                isPrePopulated: true,
              },
              {
                name: "CFA & BO, 2x250, Parichha Jhansi",
                bank: "State Bank of India, Parichha",
                accountNo: "31411639473",
                accountType: "C/A/c",
                ifsc: "SBIN0006149",
                amount: 0,
                isPrePopulated: true,
              },
              {
                name: "CFA & BO, JVUNL",
                bank: "Punjab National Bank",
                accountNo: "2789002100007763",
                accountType: "C/A/c",
                ifsc: "PUNB0364300",
                amount: 0,
                isPrePopulated: true,
              },
              {
                name: "EE,HOPS,OBRA",
                bank: "State Bank of India,",
                accountNo: "10699044299",
                accountType: "C/A/c",
                ifsc: "SBIN0001241",
                amount: 0,
                isPrePopulated: true,
              },
            ],
          },
        },
        computed: {
          accountsTotal() {
            return this.formData.accounts.reduce((sum, acc) => sum + (acc.amount || 0), 0);
          },
          amountInWords() {
            return this.numberToWords(Math.floor(this.accountsTotal));
          },
        },
        watch: {
          // One-way sync: when top date changes, update cheque date
          "formData.date"(newDate) {
            this.isAutoSyncingChequeDate = true;
            this.formData.chequeDate = newDate;
            this.$nextTick(() => {
              this.isAutoSyncingChequeDate = false;
            });
          },
        },
        filters: {
          currency(value) {
            if (!value) return "0.00";
            return parseFloat(value).toLocaleString("en-IN", {
              minimumFractionDigits: 2,
              maximumFractionDigits: 2,
            });
          },
        },
        methods: {
          formatDate(dateStr) {
            const date = new Date(dateStr);
            return date
              .toLocaleDateString("en-GB", {
                day: "2-digit",
                month: "2-digit",
                year: "numeric",
              })
              .replace(/\//g, "-");
          },
          numberToWords(num) {
            if (num === 0) return "ZERO";

            const ones = ["", "ONE", "TWO", "THREE", "FOUR", "FIVE", "SIX", "SEVEN", "EIGHT", "NINE", "TEN", "ELEVEN", "TWELVE", "THIRTEEN", "FOURTEEN", "FIFTEEN", "SIXTEEN", "SEVENTEEN", "EIGHTEEN", "NINETEEN"];
            const tens = ["", "", "TWENTY", "THIRTY", "FORTY", "FIFTY", "SIXTY", "SEVENTY", "EIGHTY", "NINETY"];

            function convertHundreds(n) {
              let result = "";
              if (n >= 100) {
                result += ones[Math.floor(n / 100)] + " HUNDRED ";
                n %= 100;
              }
              if (n >= 20) {
                result += tens[Math.floor(n / 10)] + " ";
                n %= 10;
              }
              if (n > 0) {
                result += ones[n] + " ";
              }
              return result.trim();
            }

            let crores = Math.floor(num / 10000000);
            let lakhs = Math.floor((num % 10000000) / 100000);
            let thousands = Math.floor((num % 100000) / 1000);
            let hundreds = num % 1000;

            let result = "";
            if (crores > 0) result += convertHundreds(crores) + " CRORE ";
            if (lakhs > 0) result += convertHundreds(lakhs) + " LAKH ";
            if (thousands > 0) result += convertHundreds(thousands) + " THOUSAND ";
            if (hundreds > 0) result += convertHundreds(hundreds);

            return result.trim();
          },
          addAccount() {
            this.formData.accounts.push({
              name: "",
              bank: "",
              accountNo: "",
              accountType: "C/A/c",
              ifsc: "",
              amount: 0,
              isPrePopulated: false,
            });
          },
          removeAccount(index) {
            if (this.formData.accounts.length > 1) {
              if (confirm("Are you sure you want to remove this account?")) {
                this.formData.accounts.splice(index, 1);
              }
            } else {
              alert("At least one account row is required.");
            }
          },
          generatePreview() {
            // Check if there are any accounts with valid data
            const hasValidAccounts = this.formData.accounts.some((acc) => acc.amount > 0 && acc.name && acc.name.trim() !== "");
            if (!hasValidAccounts) {
              if (confirm("No valid account data has been entered yet. Do you still want to see the preview?")) {
                this.previewContent = this.createPreviewHTML();
                this.showPreview = true;
              }
              return;
            }

            this.previewContent = this.createPreviewHTML();
            this.showPreview = true;
          },
          createPreviewHTML() {
            // Filter out accounts that have no data (empty name or amount = 0)
            const nonZeroAccounts = this.formData.accounts.filter((acc) => acc.amount > 0 && acc.name && acc.name.trim() !== "");

            let accountRows = "";
            if (nonZeroAccounts.length === 0) {
              accountRows = `
                <tr>
                  <td colspan="7" style="border: 1px solid #000; padding: 15px; text-align: center;">
                    <em>No accounts with amounts entered. Please enter amounts in the form above.</em>
                  </td>
                </tr>
              `;
            } else {
              accountRows = nonZeroAccounts
                .map(
                  (acc, index) => `
                <tr>
                  <td style="border: 1px solid #000; padding: 5px; text-align: center;">${index + 1}</td>
                  <td style="border: 1px solid #000; padding: 5px;">${acc.name}</td>
                  <td style="border: 1px solid #000; padding: 5px;">${acc.bank}</td>
                  <td style="border: 1px solid #000; padding: 5px;">${acc.accountNo}</td>
                  <td style="border: 1px solid #000; padding: 5px; text-align: center;">${acc.accountType}</td>
                  <td style="border: 1px solid #000; padding: 5px;">${acc.ifsc}</td>
                  <td style="border: 1px solid #000; padding: 5px; text-align: right;">${(acc.amount || 0).toLocaleString("en-IN", {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2,
                  })}</td>
                </tr>
              `
                )
                .join("");
            }

            return `
              <div style="max-width: 800px; margin: 0 auto; font-family: Arial, sans-serif; font-size: 14px;">
                <!-- Header with Logo and Address -->
                <div style="text-align: center; margin-bottom: 20px;">
                  <div style="display: flex; align-items: flex-start; justify-content: center; gap: 20px;">
                    <div style="flex-shrink: 0; margin-top: 10px;">
                      <img src="${this.logoUrl}" alt="UPRVUNL Logo" style="width: 100px; height: auto;" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
                      <div style="width: 80px; height: 80px; border: 2px solid #000; border-radius: 50%; display: none; align-items: center; justify-content: center;">
                        <span style="font-size: 10px;">UPRVUNL</span>
                      </div>
                    </div>
                    <div style="flex: 1; text-align: center;">
                      <h2 style="margin: 0; font-size: 16px; font-weight: bold;">U.P. RAJYA VIDYUT UTPADAN NIGAM CPF TRUST</h2>
                      <p style="margin: 2px 0; font-size: 14px; font-weight: bold;">9th Floor, Shakti Bhawan Extn., Room No. 928</p>
                      <p style="margin: 2px 0; font-size: 14px; font-weight: bold;">14-Ashok Marg, Lucknow - 226001</p>
                      <p style="margin: 2px 0; font-size: 14px; font-weight: bold;">उत्तर प्रदेश राज्य विद्युत उत्पादन निगम लि0 सी0पी0एफ0 ट्रस्ट,</p>
                      <p style="margin: 2px 0; font-size: 14px; font-weight: bold;">9वीं तल, शक्ति भवन विस्तार, कक्ष संख्या – 928,</p>
                      <p style="margin: 2px 0; font-size: 14px; font-weight: bold;">14. अशोक मार्ग, लखनऊ – 226 001</p>
                    </div>
                  </div>
                </div>

                <!-- Separator Line -->
                <div style="border-bottom: 1px solid #000000; margin: 10px 0 20px 0;"></div>

                <!-- Letter Number and Date -->
                <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                  <div><strong>NO. ${this.formData.letterNo}</strong></div>
                  <div><strong>DATED: ${this.formatDate(this.formData.date)}</strong></div>
                </div>

                <!-- Recipient -->
                <div style="margin-bottom: 20px;">
                  <p style="margin: 2px 0;">${this.formData.recipientDesignation},</p>
                  <p style="margin: 2px 0;">${this.formData.bankName},</p>
                  <p style="margin: 2px 0;">${this.formData.branchAddress}</p>
                </div>

                <!-- Subject -->
                <div style="margin-bottom: 20px; text-align: center;">
                  <p style="margin: 0;"><strong><u>Subject: Transfer of Fund through RTGS</u></strong></p>
                </div>

                <!-- Body -->
                <div style="margin-bottom: 20px; text-align: justify;">
                  <p style="margin: 5px 0;">Dear Sir,</p>
                  <p style="margin: 5px 0; text-indent: 50px;">
                    You are aware that UPRVUNL CPF Trust remits the amount to the projects on their demand basically for the welfare of the employees. Accordingly, you are requested to kindly transfer Fund from our CBI A/c ${this.formData.cbiAccountNo} with PAN No. ${this.formData.panNo}, through RTGS to the transferee account as per detail given below:-
                  </p>
                </div>

                <!-- Account Details Table -->
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 11px;">
                  <thead>
                    <tr style="background-color: #f0f0f0;">
                      <th style="border: 1px solid #000; padding: 5px; text-align: center;">Sl.<br/>No.</th>
                      <th style="border: 1px solid #000; padding: 5px;">Name of Account</th>
                      <th style="border: 1px solid #000; padding: 5px;">Bank/ Branch</th>
                      <th style="border: 1px solid #000; padding: 5px;">Account No.</th>
                      <th style="border: 1px solid #000; padding: 5px;">Type<br/>of A/c</th>
                      <th style="border: 1px solid #000; padding: 5px;">IFSC Code</th>
                      <th style="border: 1px solid #000; padding: 5px;">Amount</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${accountRows}
                    <tr style="background-color: #f0f0f0; font-weight: bold;">
                      <td colspan="6" style="border: 1px solid #000; padding: 5px; text-align: right;">Total</td>
                      <td style="border: 1px solid #000; padding: 5px; text-align: right;">${this.accountsTotal.toLocaleString("en-IN", {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2,
                      })}</td>
                    </tr>
                  </tbody>
                </table>

                <!-- Cheque Details -->
                <div style="margin-bottom: 20px; text-align: justify;">
                  <p style="margin: 5px 0; text-indent: 50px;">
                    Please find herewith Cheque No <strong>${this.formData.chequeNo}</strong> dated <strong>${this.formatDate(this.formData.chequeDate)}</strong> authorising for payment amounting <strong>Rs.${this.accountsTotal.toLocaleString("en-IN", {
              minimumFractionDigits: 2,
              maximumFractionDigits: 2,
            })}</strong> <strong>(Rs. ${this.amountInWords} ONLY)</strong> as per table above for RTGS transfer at our projects.
                  </p>
                </div>

                <!-- Closing -->
                <div style="margin-bottom: 20px;">
                  <p style="margin: 5px 0;">Thanking You,</p>
                  <p style="margin: 5px 0;">Encl. As Above.</p>
                </div>

                <!-- Signature -->
                <div style="text-align: right; margin-top: 60px;">
                  <p style="margin: 0; font-weight: bold;">For UPRVUNL CPF TRUST</p>
                  <p style="margin: 100px 0 5px 0; font-weight: bold;">(Pradeep Soni)</p>
                  <p style="margin: 0; font-weight: bold;">Secretary (Trust)</p>
                </div>
              </div>
            `;
          },
          async generateDocx() {
            try {
              // Check if there are any accounts with valid data
              const hasValidAccounts = this.formData.accounts.some((acc) => acc.amount > 0 && acc.name && acc.name.trim() !== "");
              if (!hasValidAccounts) {
                alert("Please enter at least one valid account with name and amount before generating the document.");
                return;
              }

              console.log("Attempting to generate DOCX...");

              let docxLib;
              if (typeof window.docx !== "undefined") {
                docxLib = window.docx;
              } else if (typeof docx !== "undefined") {
                docxLib = docx;
              } else {
                throw new Error("DOCX library not loaded. Please refresh the page and try again.");
              }

              const { Document, Packer, Paragraph, TextRun, Table, TableRow, TableCell, AlignmentType, WidthType, BorderStyle, HeadingLevel, UnderlineType, ImageRun } = docxLib;

              // Fetch logo image from local file
              let logoImageData = null;
              try {
                console.log("Fetching logo from:", this.logoUrl);
                const response = await fetch(this.logoUrl);
                if (!response.ok) {
                  throw new Error(`Failed to fetch logo: ${response.status}`);
                }
                const blob = await response.blob();
                const arrayBuffer = await blob.arrayBuffer();
                logoImageData = new Uint8Array(arrayBuffer);
                console.log("Logo fetched successfully, size:", logoImageData.length, "bytes");
              } catch (error) {
                console.error("Could not fetch logo:", error);
                alert("Note: Logo could not be loaded. The document will be generated without the logo.");
              }

              // Filter out accounts that have no data (empty name or amount = 0)
              const nonZeroAccounts = this.formData.accounts.filter((acc) => acc.amount > 0 && acc.name && acc.name.trim() !== "");

              // Create account table rows
              const accountTableRows = nonZeroAccounts.map(
                (acc, index) =>
                  new TableRow({
                    children: [
                      new TableCell({
                        children: [
                          new Paragraph({
                            children: [new TextRun({ text: (index + 1).toString(), size: 16 })],
                            alignment: AlignmentType.CENTER,
                          }),
                        ],
                        width: { size: 5, type: WidthType.PERCENTAGE },
                        margins: { top: 30, bottom: 30, left: 20, right: 20 },
                      }),
                      new TableCell({
                        children: [
                          new Paragraph({
                            children: [new TextRun({ text: acc.name || "", size: 16 })],
                          }),
                        ],
                        width: { size: 20, type: WidthType.PERCENTAGE },
                        margins: { top: 30, bottom: 30, left: 20, right: 20 },
                      }),
                      new TableCell({
                        children: [
                          new Paragraph({
                            children: [new TextRun({ text: acc.bank || "", size: 16 })],
                          }),
                        ],
                        width: { size: 20, type: WidthType.PERCENTAGE },
                        margins: { top: 30, bottom: 30, left: 20, right: 20 },
                      }),
                      new TableCell({
                        children: [
                          new Paragraph({
                            children: [new TextRun({ text: acc.accountNo || "", size: 16 })],
                          }),
                        ],
                        width: { size: 15, type: WidthType.PERCENTAGE },
                        margins: { top: 30, bottom: 30, left: 20, right: 20 },
                      }),
                      new TableCell({
                        children: [
                          new Paragraph({
                            children: [new TextRun({ text: acc.accountType || "", size: 16 })],
                            alignment: AlignmentType.CENTER,
                          }),
                        ],
                        width: { size: 10, type: WidthType.PERCENTAGE },
                        margins: { top: 30, bottom: 30, left: 20, right: 20 },
                      }),
                      new TableCell({
                        children: [
                          new Paragraph({
                            children: [new TextRun({ text: acc.ifsc || "", size: 16 })],
                          }),
                        ],
                        width: { size: 15, type: WidthType.PERCENTAGE },
                        margins: { top: 30, bottom: 30, left: 20, right: 20 },
                      }),
                      new TableCell({
                        children: [
                          new Paragraph({
                            children: [
                              new TextRun({
                                text: (acc.amount || 0).toLocaleString("en-IN", {
                                  minimumFractionDigits: 2,
                                  maximumFractionDigits: 2,
                                }),
                                size: 16,
                              }),
                            ],
                            alignment: AlignmentType.RIGHT,
                          }),
                        ],
                        width: { size: 15, type: WidthType.PERCENTAGE },
                        margins: { top: 30, bottom: 30, left: 20, right: 20 },
                      }),
                    ],
                  })
              );

              // Add total row
              accountTableRows.push(
                new TableRow({
                  children: [
                    new TableCell({
                      children: [
                        new Paragraph({
                          children: [new TextRun({ text: "Total", bold: true, size: 16 })],
                          alignment: AlignmentType.RIGHT,
                        }),
                      ],
                      columnSpan: 6,
                      margins: { top: 30, bottom: 30, left: 20, right: 20 },
                    }),
                    new TableCell({
                      children: [
                        new Paragraph({
                          children: [
                            new TextRun({
                              text: this.accountsTotal.toLocaleString("en-IN", {
                                minimumFractionDigits: 2,
                                maximumFractionDigits: 2,
                              }),
                              bold: true,
                              size: 16,
                            }),
                          ],
                          alignment: AlignmentType.RIGHT,
                        }),
                      ],
                      margins: { top: 30, bottom: 30, left: 20, right: 20 },
                    }),
                  ],
                })
              );

              const doc = new Document({
                styles: {
                  default: {
                    document: {
                      run: {
                        font: "Arial",
                        size: 18,
                      },
                    },
                  },
                },
                sections: [
                  {
                    properties: {
                      page: {
                        margin: {
                          top: 360,
                          right: 720,
                          bottom: 360,
                          left: 720,
                        },
                      },
                    },
                    children: [
                      // Header with Logo and Organization Name (side by side using table)
                      new Table({
                        width: { size: 100, type: WidthType.PERCENTAGE },
                        borders: {
                          top: { style: BorderStyle.NONE },
                          bottom: { style: BorderStyle.NONE },
                          left: { style: BorderStyle.NONE },
                          right: { style: BorderStyle.NONE },
                          insideHorizontal: { style: BorderStyle.NONE },
                          insideVertical: { style: BorderStyle.NONE },
                        },
                        rows: [
                          new TableRow({
                            children: [
                              // Left cell - Logo
                              new TableCell({
                                children: logoImageData
                                  ? [
                                      new Paragraph({
                                        children: [
                                          new ImageRun({
                                            data: logoImageData,
                                            transformation: {
                                              width: 100,
                                              height: 100,
                                            },
                                          }),
                                        ],
                                        alignment: AlignmentType.LEFT,
                                      }),
                                    ]
                                  : [new Paragraph("")],
                                width: { size: 20, type: WidthType.PERCENTAGE },
                                verticalAlign: "center",
                                borders: {
                                  top: { style: BorderStyle.NONE },
                                  bottom: { style: BorderStyle.NONE },
                                  left: { style: BorderStyle.NONE },
                                  right: { style: BorderStyle.NONE },
                                },
                              }),
                              // Right cell - Organization details
                              new TableCell({
                                children: [
                                  new Paragraph({
                                    children: [
                                      new TextRun({
                                        text: "U.P. RAJYA VIDYUT UTPADAN NIGAM CPF TRUST",
                                        bold: true,
                                        size: 20,
                                      }),
                                    ],
                                    alignment: AlignmentType.CENTER,
                                    spacing: { after: 60 },
                                  }),
                                  new Paragraph({
                                    children: [
                                      new TextRun({
                                        text: "9th Floor, Shakti Bhawan Extn., Room No. 928",
                                        size: 20,
                                        bold: true,
                                      }),
                                    ],
                                    alignment: AlignmentType.CENTER,
                                    spacing: { after: 40 },
                                  }),
                                  new Paragraph({
                                    children: [
                                      new TextRun({
                                        text: "14-Ashok Marg, Lucknow - 226001",
                                        size: 20,
                                        bold: true,
                                      }),
                                    ],
                                    alignment: AlignmentType.CENTER,
                                    spacing: { after: 40 },
                                  }),
                                  new Paragraph({
                                    children: [
                                      new TextRun({
                                        text: "उत्तर प्रदेश राज्य विद्युत उत्पादन निगम लि0 सी0पी0एफ0 ट्रस्ट,",
                                        size: 20,
                                        bold: true,
                                      }),
                                    ],
                                    alignment: AlignmentType.CENTER,
                                    spacing: { after: 40 },
                                  }),
                                  new Paragraph({
                                    children: [
                                      new TextRun({
                                        text: "9वीं तल, शक्ति भवन विस्तार, कक्ष संख्या – 928,",
                                        size: 20,
                                        bold: true,
                                      }),
                                    ],
                                    alignment: AlignmentType.CENTER,
                                    spacing: { after: 40 },
                                  }),
                                  new Paragraph({
                                    children: [
                                      new TextRun({
                                        text: "14. अशोक मार्ग, लखनऊ – 226 001",
                                        size: 20,
                                        bold: true,
                                      }),
                                    ],
                                    alignment: AlignmentType.CENTER,
                                  }),
                                ],
                                width: { size: 80, type: WidthType.PERCENTAGE },
                                verticalAlign: "center",
                                borders: {
                                  top: { style: BorderStyle.NONE },
                                  bottom: { style: BorderStyle.NONE },
                                  left: { style: BorderStyle.NONE },
                                  right: { style: BorderStyle.NONE },
                                },
                              }),
                            ],
                          }),
                        ],
                      }),
                      new Paragraph({
                        children: [new TextRun("")],
                        spacing: { after: 40 },
                      }),

                      // Separator Line
                      new Paragraph({
                        children: [new TextRun("")],
                        border: {
                          bottom: {
                            color: "000000",
                            space: 1,
                            style: BorderStyle.SINGLE,
                            size: 6,
                          },
                        },
                        spacing: { after: 100 },
                      }),

                      // Letter No and Date
                      new Table({
                        width: { size: 100, type: WidthType.PERCENTAGE },
                        borders: {
                          top: { style: BorderStyle.NONE },
                          bottom: { style: BorderStyle.NONE },
                          left: { style: BorderStyle.NONE },
                          right: { style: BorderStyle.NONE },
                          insideHorizontal: { style: BorderStyle.NONE },
                          insideVertical: { style: BorderStyle.NONE },
                        },
                        rows: [
                          new TableRow({
                            children: [
                              new TableCell({
                                children: [
                                  new Paragraph({
                                    children: [
                                      new TextRun({
                                        text: `NO. ${this.formData.letterNo}`,
                                        bold: true,
                                      }),
                                    ],
                                  }),
                                ],
                                width: { size: 50, type: WidthType.PERCENTAGE },
                                borders: {
                                  top: { style: BorderStyle.NONE },
                                  bottom: { style: BorderStyle.NONE },
                                  left: { style: BorderStyle.NONE },
                                  right: { style: BorderStyle.NONE },
                                },
                              }),
                              new TableCell({
                                children: [
                                  new Paragraph({
                                    children: [
                                      new TextRun({
                                        text: `DATED: ${this.formatDate(this.formData.date)}`,
                                        bold: true,
                                      }),
                                    ],
                                    alignment: AlignmentType.RIGHT,
                                  }),
                                ],
                                width: { size: 50, type: WidthType.PERCENTAGE },
                                borders: {
                                  top: { style: BorderStyle.NONE },
                                  bottom: { style: BorderStyle.NONE },
                                  left: { style: BorderStyle.NONE },
                                  right: { style: BorderStyle.NONE },
                                },
                              }),
                            ],
                          }),
                        ],
                      }),
                      new Paragraph({
                        children: [new TextRun("")],
                        spacing: { after: 80 },
                      }),

                      // Recipient
                      new Paragraph({
                        children: [new TextRun(`${this.formData.recipientDesignation},`)],
                        spacing: { after: 40 },
                      }),
                      new Paragraph({
                        children: [new TextRun(`${this.formData.bankName},`)],
                        spacing: { after: 40 },
                      }),
                      new Paragraph({
                        children: [new TextRun(this.formData.branchAddress)],
                        spacing: { after: 100 },
                      }),

                      // Subject
                      new Paragraph({
                        children: [
                          new TextRun({
                            text: "Subject: Transfer of Fund through RTGS",
                            bold: true,
                            underline: {
                              type: UnderlineType.SINGLE,
                            },
                          }),
                        ],
                        alignment: AlignmentType.CENTER,
                        spacing: { after: 100 },
                      }),

                      // Body
                      new Paragraph({
                        children: [new TextRun("Dear Sir,")],
                        spacing: { after: 80 },
                      }),
                      new Paragraph({
                        children: [
                          new TextRun({
                            text: `     You are aware that UPRVUNL CPF Trust remits the amount to the projects on their demand basically for the welfare of the employees. Accordingly, you are requested to kindly transfer Fund our CBI A/c ${this.formData.cbiAccountNo} with PAN No. ${this.formData.panNo}, through RTGS to the transferee account as per detail given below:-`,
                          }),
                        ],
                        alignment: AlignmentType.JUSTIFIED,
                        spacing: { after: 100 },
                      }),

                      // Account Details Table
                      new Table({
                        width: { size: 100, type: WidthType.PERCENTAGE },
                        rows: [
                          // Header row
                          new TableRow({
                            children: [
                              new TableCell({
                                children: [
                                  new Paragraph({
                                    children: [new TextRun({ text: "Sl.\nNo.", bold: true, size: 16 })],
                                    alignment: AlignmentType.CENTER,
                                  }),
                                ],
                                width: { size: 5, type: WidthType.PERCENTAGE },
                                margins: { top: 30, bottom: 30, left: 20, right: 20 },
                              }),
                              new TableCell({
                                children: [
                                  new Paragraph({
                                    children: [new TextRun({ text: "Name of Account", bold: true, size: 16 })],
                                    alignment: AlignmentType.CENTER,
                                  }),
                                ],
                                width: { size: 20, type: WidthType.PERCENTAGE },
                                margins: { top: 30, bottom: 30, left: 20, right: 20 },
                              }),
                              new TableCell({
                                children: [
                                  new Paragraph({
                                    children: [new TextRun({ text: "Bank/ Branch", bold: true, size: 16 })],
                                    alignment: AlignmentType.CENTER,
                                  }),
                                ],
                                width: { size: 20, type: WidthType.PERCENTAGE },
                                margins: { top: 30, bottom: 30, left: 20, right: 20 },
                              }),
                              new TableCell({
                                children: [
                                  new Paragraph({
                                    children: [new TextRun({ text: "Account No.", bold: true, size: 16 })],
                                    alignment: AlignmentType.CENTER,
                                  }),
                                ],
                                width: { size: 15, type: WidthType.PERCENTAGE },
                                margins: { top: 30, bottom: 30, left: 20, right: 20 },
                              }),
                              new TableCell({
                                children: [
                                  new Paragraph({
                                    children: [new TextRun({ text: "Type\nof A/c", bold: true, size: 16 })],
                                    alignment: AlignmentType.CENTER,
                                  }),
                                ],
                                width: { size: 10, type: WidthType.PERCENTAGE },
                                margins: { top: 30, bottom: 30, left: 20, right: 20 },
                              }),
                              new TableCell({
                                children: [
                                  new Paragraph({
                                    children: [new TextRun({ text: "IFSC Code", bold: true, size: 16 })],
                                    alignment: AlignmentType.CENTER,
                                  }),
                                ],
                                width: { size: 15, type: WidthType.PERCENTAGE },
                                margins: { top: 30, bottom: 30, left: 20, right: 20 },
                              }),
                              new TableCell({
                                children: [
                                  new Paragraph({
                                    children: [new TextRun({ text: "Amount", bold: true, size: 16 })],
                                    alignment: AlignmentType.CENTER,
                                  }),
                                ],
                                width: { size: 15, type: WidthType.PERCENTAGE },
                                margins: { top: 30, bottom: 30, left: 20, right: 20 },
                              }),
                            ],
                          }),
                          // Data rows
                          ...accountTableRows,
                        ],
                      }),
                      new Paragraph({
                        children: [new TextRun("")],
                        spacing: { after: 100 },
                      }),

                      // Cheque details paragraph
                      new Paragraph({
                        children: [
                          new TextRun({
                            text: `     Please find herewith Cheque No `,
                          }),
                          new TextRun({
                            text: this.formData.chequeNo,
                            bold: true,
                          }),
                          new TextRun({
                            text: ` dated `,
                          }),
                          new TextRun({
                            text: this.formatDate(this.formData.chequeDate),
                            bold: true,
                          }),
                          new TextRun({
                            text: ` authorising for payment amounting `,
                          }),
                          new TextRun({
                            text: `Rs.${this.accountsTotal.toLocaleString("en-IN", {
                              minimumFractionDigits: 2,
                              maximumFractionDigits: 2,
                            })}`,
                            bold: true,
                          }),
                          new TextRun({
                            text: ` `,
                          }),
                          new TextRun({
                            text: `(Rs. ${this.amountInWords} ONLY)`,
                            bold: true,
                          }),
                          new TextRun({
                            text: " as per table above for RTGS transfer at our projects.",
                          }),
                        ],
                        alignment: AlignmentType.JUSTIFIED,
                        spacing: { after: 100 },
                      }),

                      // Closing
                      new Paragraph({
                        children: [new TextRun("Thanking You,")],
                        spacing: { after: 40 },
                      }),
                      new Paragraph({
                        children: [new TextRun("Encl. As Above.")],
                        spacing: { after: 120 },
                      }),

                      // Signature
                      new Paragraph({
                        children: [new TextRun({ text: "For UPRVUNL CPF TRUST", bold: true })],
                        alignment: AlignmentType.RIGHT,
                        spacing: { after: 500 },
                      }),
                      new Paragraph({
                        children: [new TextRun({ text: "(Pradeep Soni)", bold: true })],
                        alignment: AlignmentType.RIGHT,
                        spacing: { after: 40 },
                      }),
                      new Paragraph({
                        children: [new TextRun({ text: "Secretary (Trust)", bold: true })],
                        alignment: AlignmentType.RIGHT,
                      }),
                    ],
                  },
                ],
              });

              const blob = await Packer.toBlob(doc);
              const dateObj = new Date(this.formData.date);
              const monthName = dateObj.toLocaleDateString("en-US", {
                month: "long",
              });
              const year = dateObj.getFullYear();
              const fileName = `Bank_Letter_RTGS_${monthName}_${year}.docx`;
              saveAs(blob, fileName);

              alert("DOCX file generated successfully!");
            } catch (error) {
              console.error("Error generating DOCX:", error);
              alert("Error generating DOCX file. Please check the console for details.");
            }
          },
          clearForm() {
            if (confirm("Are you sure you want to clear all amounts and reset custom accounts?")) {
              // Clear amounts for all accounts
              this.formData.accounts.forEach((account) => {
                account.amount = 0;
              });
              // Remove any accounts added beyond the original 14
              if (this.formData.accounts.length > 14) {
                this.formData.accounts = this.formData.accounts.slice(0, 14);
              }
              this.formData.chequeNo = "";
              this.formData.date = new Date().toISOString().split("T")[0];
              this.formData.chequeDate = new Date().toISOString().split("T")[0];
            }
          },
        },
      });
    </script>
  </body>
</html>
